---
name: api-error-handling
description: フロントエンドでAPIを繋ぎ込むときのエラーハンドリング方針（API層/フック層/UI層の責務、ステータス別の対応、モーダル/インライン表示の使い分け）を定義する。
---

# APIエラーハンドリング方針

## 目的
- API接続時のエラー処理を一貫させ、責務を明確化する
- 画面実装側の記述を最小化し、共通化可能なものは集約する

## 責務の分離

### 1) API層（`apps/frontend/src/api`）
- **責務**: HTTPレスポンスをドメインエラーに変換する
- **やること**:
  - 422のバリデーションエラーは、レスポンス本文を解析し**ユーザー向けメッセージ**を作って `ApiError` で投げる
  - 422以外のエラーは `status` を含めて `ApiError` で投げる
- **やらないこと**:
  - UI表示（モーダル/トースト/フォームエラー）を決めない

### 2) フック層（`apps/frontend/src/pages/**/hooks`）
- **責務**: ステータスコードに基づく**表示戦略**の決定
- **やること**:
  - 422 → **入力エラーとしてフォームに表示**
  - 422以外 → **グローバルエラーモーダル**を表示
  - 401/403 → 認証/権限エラーとして再ログイン案内を出す
  - 500系 → サーバー障害として再試行案内を出す
- **やらないこと**:
  - APIレスポンスの構造解析（これはAPI層の責務）
  - 画面ごとの詳細文言を持ちすぎない（共通文言を優先）

### 3) UI層（ページ/コンポーネント）
- **責務**: フックから提供される `errorMessage` / `clearErrorMessage` を反映するだけ
- **やること**:
  - 422由来の `errorMessage` を Input に表示
  - それ以外のエラーは Provider が自動表示するため**UI側でErrorModalは書かない**

## ステータス別対応ルール

| ステータス | 方針 | 表示先 |
|---|---|---|
| 422 | 入力エラー | フォームのerrorText
| 401/403 | 認証/権限エラー | グローバルモーダル
| 500+ | サーバーエラー | グローバルモーダル
| その他 | 予期せぬエラー | グローバルモーダル

## 実装パターン

### API層
- `ApiError` を投げる（statusを保持）
- 422はレスポンス本文を解析しメッセージを作る

### フック層
- `useErrorModal()` を使い `showError({ title, message })`
- 422のみ `errorMessage` にセットしてUIで表示

### UI層
- `errorMessage` / `clearErrorMessage` を Input に渡す
- エラーモーダルは Provider が一元管理する

## 注意点
- 画面ごとの特別な文言が必要なら、フック側で分岐させる
- 例外的にAPIごとの詳細情報が必要なら、API層でメッセージ生成して `ApiError` に載せる
- 追加の共通エラーUIが必要な場合は `ErrorModalProvider` に集約する
