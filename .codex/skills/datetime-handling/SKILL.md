---
name: datetime-handling
description: 家事アプリの時刻・タイムゾーン運用方針（JST前提のtimestamp保存、ISO8601送受信、集計時の注意）に従って実装・設計する時に使う。
---

# 時刻・タイムゾーン運用方針

## 方針（現状）

- 国内向け前提のため、DBは `timestamp without time zone` を使用する。
- サーバーのタイムゾーンは **JST固定** とする。
- フロント/バック間の送受信は **ISO8601 + TZ付き**（`Z` または `+09:00`）で統一する。

## 背景

- 海外対応や多TZ対応を想定していないため、運用コストを最小化する。
- 送受信は標準フォーマットにして、フロント/バック間の解釈ズレを防ぐ。

## バックエンドでの扱い

- `new Date()` は直接使わず、**JSTを明示した now ユーティリティ**を使う。
- now の取得は `dayjs` + `timezone` で **Asia/Tokyo を明示**し、JST固定の前提をコードで担保する。
- 送信/受信は **必ずTZ付きISO8601** にする（TZなしは禁止）。
- “今日”など日付境界の計算は **JSTで計算**する。

## now取得の明示（必須）

- `nowJst()` を使用して **JSTの現在時刻**を取得し、DB保存時は `toDate()` へ変換する。
- `dayjs.extend(utc)` と `dayjs.extend(timezone)` は **`.tz()` を使うために必須**。
- 背景: Edge実行環境はサーバーTZを変更できない前提のため、**アプリ側でTZを明示**して安全に統一する。

## フロントエンドでの扱い

- APIへ送る日時は **ISO8601 + TZ付き**。
- 受け取った日時は `new Date(isoString)` で表示用に変換する。

## DBでの扱い

- 型は `timestamp without time zone`（= `timestamp`）。
- DBはタイムゾーン情報を保持しない前提のため、**JST基準で保存されている**という運用ルールを共有する。

## 注意点（必須）

- `timestamp` はTZ情報が消えるため、**UTCとJSTが混在すると判別不能**になる。
- サーバーTZが変更されると保存時刻がズレるので、**JST固定を厳守**する。
- 将来、海外対応やサーバーTZ変更が必要になった場合は **`timestamptz` 移行**を検討する。
- ISO8601のタイムゾーン付きでやり取りする理由は、送受信でTZなし（`YYYY-MM-DDTHH:mm:ss`）を混ぜると、**JSがローカル時刻として解釈**しズレる。
