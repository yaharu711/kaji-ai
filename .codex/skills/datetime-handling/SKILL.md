---
name: datetime-handling
description: 家事アプリの時刻・タイムゾーン運用方針（UTC保存・JST表示、ISO8601送受信、集計時の注意）に従って実装・設計する時に使う。
---

# 時刻・タイムゾーン運用方針

## 方針（現状）

- 国内向け前提でも、DBは **UTC基準で保存**する。
- DBは `timestamp without time zone` を使用し、保存時にUTCへ正規化される前提で扱う。
- フロント/バック間の送受信は **ISO8601 + TZ付き**（`Z` または `+09:00`）で統一する。

## 背景

- 海外対応や多TZ対応を想定していないため、運用コストを最小化する。
- 送受信は標準フォーマットにして、フロント/バック間の解釈ズレを防ぐ。

## バックエンドでの扱い

- `new Date()` は「現在の瞬間」を表す用途として利用可。保存はUTC基準で扱う。
- now の取得で **JSTの境界計算**が必要な場合は `dayjs` + `timezone` で **Asia/Tokyo を明示**する。
- 送信/受信は **必ずTZ付きISO8601** にする（TZなしは禁止）。
- “今日”など日付境界の計算は **JSTで計算し、UTCに変換してクエリ**する。

## now取得の明示（必須）

- `nowJst()` は **JSTの境界計算**に使う。保存時刻の生成は `new Date()` などUTC基準で統一する。
- `dayjs.extend(utc)` と `dayjs.extend(timezone)` は **`.tz()` を使うために必須**。
- 背景: Drizzle ORM により **JSTで作った日時もUTC表現に正規化されて保存**されるため、保存はUTC基準で揃える方が混乱が少ない。

## フロントエンドでの扱い

- APIへ送る日時は **ISO8601 + TZ付き**。
- 受け取った日時は **表示時にタイムゾーンを明示**する（`Intl.DateTimeFormat` など）。

## DBでの扱い

- 型は `timestamp without time zone`（= `timestamp`）。
- DBはタイムゾーン情報を保持しない前提のため、**UTC基準で保存されている**という運用ルールを共有する。
- Drizzle ORM は `Date` を渡すと **UTC表現に正規化されて保存**される。

## 注意点（必須）

- `timestamp` はTZ情報が消えるため、**UTCとJSTが混在すると判別不能**になる。
- サーバーTZに依存せず、**UTC保存に統一**する。
- 将来、海外対応やサーバーTZ変更が必要になった場合は **`timestamptz` 移行**を検討する。
- ISO8601のタイムゾーン付きでやり取りする理由は、送受信でTZなし（`YYYY-MM-DDTHH:mm:ss`）を混ぜると、**JSがローカル時刻として解釈**しズレる。

## 追記（方針の理由）

- Drizzle ORM により、JSTの時刻を渡しても **UTC表現に変換されてDBへ保存**される。
- JSTで保存したい場合は、生SQLでJST前提の値を保存する運用も可能だが、
  **無理にJSTへ寄せずUTC保存に統一し、アプリ側でタイムゾーンを指定**する方が理解しやすい。
- UTC保存に揃えることで、将来的な拡張（多TZ対応・分析基盤連携）にも対応しやすい。
